<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack学习笔记（五）——打包速度优化 | HUSHUXIAN&#39;S BLOG</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="持续更新中...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.62d27ebb.css" as="style"><link rel="preload" href="/assets/js/app.b1d9f2a1.js" as="script"><link rel="preload" href="/assets/js/2.47a4bf59.js" as="script"><link rel="preload" href="/assets/js/3.e41f40e8.js" as="script"><link rel="preload" href="/assets/js/30.ac5c5894.js" as="script"><link rel="prefetch" href="/assets/js/10.0a0bcc58.js"><link rel="prefetch" href="/assets/js/11.51b7cd44.js"><link rel="prefetch" href="/assets/js/12.62f38067.js"><link rel="prefetch" href="/assets/js/13.01e86525.js"><link rel="prefetch" href="/assets/js/14.71016909.js"><link rel="prefetch" href="/assets/js/15.6730739b.js"><link rel="prefetch" href="/assets/js/16.6d2aa4c8.js"><link rel="prefetch" href="/assets/js/17.7dd36a01.js"><link rel="prefetch" href="/assets/js/18.048bac97.js"><link rel="prefetch" href="/assets/js/19.c337100b.js"><link rel="prefetch" href="/assets/js/20.eacfba18.js"><link rel="prefetch" href="/assets/js/21.05902e31.js"><link rel="prefetch" href="/assets/js/22.548fbe7b.js"><link rel="prefetch" href="/assets/js/23.a15335a8.js"><link rel="prefetch" href="/assets/js/24.4f3a2a75.js"><link rel="prefetch" href="/assets/js/25.60b21fe0.js"><link rel="prefetch" href="/assets/js/26.85f9565c.js"><link rel="prefetch" href="/assets/js/27.57ce860b.js"><link rel="prefetch" href="/assets/js/28.525c90b4.js"><link rel="prefetch" href="/assets/js/29.0a3753ff.js"><link rel="prefetch" href="/assets/js/4.a302ee12.js"><link rel="prefetch" href="/assets/js/5.351476c6.js"><link rel="prefetch" href="/assets/js/6.d035f5bd.js"><link rel="prefetch" href="/assets/js/7.03aff7e4.js"><link rel="prefetch" href="/assets/js/8.ee3588c8.js"><link rel="prefetch" href="/assets/js/9.36ff3441.js">
    <link rel="stylesheet" href="/assets/css/0.styles.62d27ebb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><a href="/" class="home-link router-link-active"><!----> <span class="site-name">HUSHUXIAN'S BLOG</span> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博文</a></div><div class="nav-item"><a href="/about/" class="nav-link">简介</a></div><div class="nav-item"><a href="https://github.com/hushuxian" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博文</a></div><div class="nav-item"><a href="/about/" class="nav-link">简介</a></div><div class="nav-item"><a href="https://github.com/hushuxian" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>博文列表</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/" aria-current="page" class="sidebar-link">webpack学习笔记1——webpack基础</a></li><li><a href="/posts/webpack学习笔记（二）.html" class="sidebar-link">webpack学习笔记（二）——webpack环境和自定义loader</a></li><li><a href="/posts/webpack学习笔记（三）.html" class="sidebar-link">webpack学习笔记（三）——图片和资源的处理</a></li><li><a href="/posts/webpack学习笔记（四）.html" class="sidebar-link">webpack学习笔记（四）——代码分割和速度优化</a></li><li><a href="/posts/webpack学习笔记（五）.html" class="active sidebar-link">webpack学习笔记（五）——打包速度优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/webpack学习笔记（五）.html#webpack打包结果可视化" class="sidebar-link">webpack打包结果可视化</a></li><li class="sidebar-sub-header"><a href="/posts/webpack学习笔记（五）.html#mini-css-ectract-plugin的使用" class="sidebar-link">mini-css-ectract-plugin的使用</a></li><li class="sidebar-sub-header"><a href="/posts/webpack学习笔记（五）.html#优化打包速度" class="sidebar-link">优化打包速度</a></li></ul></li><li><a href="/posts/vue学习笔记（一）.html" class="sidebar-link">vue学习笔记(一)——安装和创建实例</a></li><li><a href="/posts/vue学习笔记（二）.html" class="sidebar-link">vue学习笔记(二)——计算属性和watch</a></li><li><a href="/posts/vue学习笔记（三）.html" class="sidebar-link">vue学习笔记(三)——组件</a></li><li><a href="/posts/vue学习笔记（四）.html" class="sidebar-link">vue学习笔记(四)——slot插槽</a></li><li><a href="/posts/vue学习笔记（五）.html" class="sidebar-link">vue学习笔记(五)——单文件和自定义组件</a></li><li><a href="/posts/vue学习笔记（六）.html" class="sidebar-link">vue学习笔记(六)——生命周期</a></li><li><a href="/posts/ES6学习笔记（一）.html" class="sidebar-link">ES6学习笔记1——let,const</a></li><li><a href="/posts/ES6学习笔记（二）.html" class="sidebar-link">ES6学习笔记2——解构赋值</a></li><li><a href="/posts/ES6学习笔记（三）.html" class="sidebar-link">ES6学习笔记3——字符串模板、字符串新增函数</a></li><li><a href="/posts/ES6学习笔记（四）.html" class="sidebar-link">ES6学习笔记4——箭头函数，函数默认参数、剩余参数</a></li><li><a href="/posts/h5常用API-位置信息、cache.html" class="sidebar-link">H5常用API——跨文档通讯</a></li><li><a href="/posts/h5常用API-跨文档通讯.html" class="sidebar-link">H5常用API——跨文档通讯</a></li><li><a href="/posts/git密钥配置.html" class="sidebar-link">git推送时报错permission denied解决方法</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="webpack打包结果可视化"><a href="#webpack打包结果可视化" class="header-anchor">#</a> webpack打包结果可视化</h2> <p>（1）官方版本
mac下使用命令：<code>webpack --profile --json &gt; stats.json</code>
windows：<code>webpack --profile --json | Out-file 'stats.json' -Encoding OEM</code>
ps:windows下须在powershell里运行命令，否则报错。</p> <p>在<a href="http://webpack.github.io/analyse/" target="_blank" rel="noopener noreferrer">webpack.github.io/analyse/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>里可视化查看stats.json。</p> <p>（2）社区版本：webpack-bundle-analyzer
安装：npm install webpack-bundle-analyzer -s
配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> wba <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span><span class="token comment">//引入插件里的BundleanAlyzerPlugin</span>
<span class="token keyword">new</span> <span class="token class-name">wba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//在插件里new一个实例</span>

</code></pre></div><h2 id="mini-css-ectract-plugin的使用"><a href="#mini-css-ectract-plugin的使用" class="header-anchor">#</a> mini-css-ectract-plugin的使用</h2> <p><strong>extract-text-webpack-plugin在webpack4中不能使用，需下载@next版本，或使用mini-css-extract-plugin代替，提取单独的css文件</strong> <strong>extract-text-webpack-plugin不支持hash命名，使用mini-css-extract-plugin使css文件支持hash命名</strong></p> <p>安装：npm install mini-css-extract-plugin -s
配置：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">let</span> miniCssExtract <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">miniCssExtract</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        filename<span class="token operator">:</span><span class="token string">'[name].css'</span>   <span class="token comment">//配置打包后的css 文件名  </span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>同时需要把原来的style-loader替换为以下形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    loader<span class="token operator">:</span>miniCssExtract<span class="token punctuation">.</span>loader
<span class="token punctuation">}</span>
</code></pre></div><h2 id="优化打包速度"><a href="#优化打包速度" class="header-anchor">#</a> 优化打包速度</h2> <p>###项目本身
（1）减少依赖嵌套深度
（2）使用尽可能少的处理
###webpack处理
（1）dll处理：把不需要改动的代码提前打包，改动业务代码只打包业务代码。</p> <p>①新建webpack.dll.js 只用来打包第三方依赖,配置如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>CleanWebpackPlugin<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'clean-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span><span class="token punctuation">{</span>
        vendor<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'jquery'</span><span class="token punctuation">,</span><span class="token string">'lodash'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//入口文件必须使用数组，可以把多个模块放入一个数组，即使只有一个模块，仍然使用数组。</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span><span class="token punctuation">{</span>
        path<span class="token operator">:</span>__dirname <span class="token operator">+</span><span class="token string">'/src/dll'</span><span class="token punctuation">,</span><span class="token comment">//打包文件存放路径</span>
        filename<span class="token operator">:</span><span class="token string">'./[name].js'</span><span class="token punctuation">,</span> <span class="token comment">//打包后的文件名</span>
        library<span class="token operator">:</span><span class="token string">'[name]'</span> <span class="token comment">//模块在项目里的引用名,与plugin配置里的name对应</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">//webpack自带的插件</span>
            path<span class="token operator">:</span>__dirname<span class="token operator">+</span><span class="token string">'/src/dll/[name].json'</span><span class="token punctuation">,</span>
            name<span class="token operator">:</span><span class="token string">'[name]'</span> <span class="token comment">//与output 里的library对应</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre></div><p>②在生产环境配置文件里添加DllReferencePlugin</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    manifest<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/dll/vendor.json'</span><span class="token punctuation">)</span> <span class="token comment">//与webpack.dll.js打包出的json路径一致</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>③将dll打包的文件引入index.html中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;../src/dll/jquery.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>（2）使用loader 的include配置loader 的处理范围</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    loader<span class="token operator">:</span><span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
    include<span class="token operator">:</span><span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//表示只处理src文件夹下的文件，注意不要添加整个node_modules,处理文件过大会报错，如需处理node_modules里的某个模块，直接指定模块，resoleve('node_modules/window')</span>
<span class="token punctuation">}</span>
</code></pre></div><p>（3）happyPack开启多进程
安装：npm install happypack -s
配置文件里引入happypack并开启多线程：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> happyPack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'happypack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span> <span class="token comment">//os是node自带模块，用来获取系统信息</span>
<span class="token keyword">const</span> happaypackThreadPool <span class="token operator">=</span> happyPack<span class="token punctuation">.</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>size<span class="token operator">:</span>os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//使用happypack的ThreadPool方法创建线程池，size表示子进程数量，os.cups().length表示获取cpu数量</span>

</code></pre></div><p>把处理js的loader里替换成happypack</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    use<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            loader<span class="token operator">:</span><span class="token string">'happypack/loader?id=happyBabel'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在plugins里注册插件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">happyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span><span class="token string">'happyBabel'</span> <span class="token punctuation">,</span><span class="token comment">//与loader里的对应</span>
    loaders<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token operator">:</span><span class="token string">&quot;babel-loader?cacheDirectory='true'&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//指定happybabel代替的loader</span>
    threadPool<span class="token operator">:</span>happypackThreadPool <span class="token comment">//指定线程池</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>（4）减少使用resolve,sourcemap,使用cache-loader,用新版本的node和webpack</p> <p>cache-loader的使用：在需要使用cache的loader里添加cache-loader即可,但是大部分loader自身都有缓存，所以cache-loader影响不大
loader:['cache-loader','url-loader']</p> <p>（5）长缓存优化
把打包hash改为chunkhash</p> <div class="language-js extra-class"><pre class="language-js"><code>filename<span class="token operator">:</span><span class="token string">'[name].[chunkhash:6].js'</span>
</code></pre></div><p>使用chunkhash当调整依赖引入顺序后打包，hash值依然会改变，因为chunk命名以id命名，调整后id改变，因此打包出来的hash值也会改变</p> <p>使用NamedChunksPlugin 和 NamedMoudulesPlugin以模块名称命名chunk,这样在改变依赖顺序时，只要名称没有改，打包hash就不会更改，webpack自带</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>NamedChunksPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>NamedModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/webpack学习笔记（四）.html" class="prev">webpack学习笔记（四）——代码分割和速度优化</a></span> <span class="next"><a href="/posts/vue学习笔记（一）.html">vue学习笔记(一)——安装和创建实例</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b1d9f2a1.js" defer></script><script src="/assets/js/2.47a4bf59.js" defer></script><script src="/assets/js/3.e41f40e8.js" defer></script><script src="/assets/js/30.ac5c5894.js" defer></script>
  </body>
</html>
